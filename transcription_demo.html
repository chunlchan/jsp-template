<!DOCTYPE html>
<html>
  <head>
    <title>Transcription Demo</title>
    <script src="https://unpkg.com/jspsych@8.2.2"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@2.0.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-survey-text@1.1.3"></script>
	<script src="https://unpkg.com/@jspsych/plugin-audio-keyboard-response@2.1.0"></script>
	<script src="https://unpkg.com/@jspsych/plugin-preload@2.1.0"></script>
	
    <link href="https://unpkg.com/jspsych@8.2.2/css/jspsych.css" rel="stylesheet" type="text/css" />
  </head>
  <body></body>


  <script type="module">
  //***firebase setup**
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js'
	import { getDatabase, ref, push } from 'https://www.gstatic.com/firebasejs/12.2.1/firebase-database.js'
    
    // Replace with your app's Firebase configuration
    const firebaseConfig = {
		apiKey: "YOUR_API_KEY",
		authDomain: "YOUR_AUTH_DOMAIN",
		databaseURL: "YOUR_DATABASE_URL",
		projectId: "YOUR_PROJECT_ID",
		storageBucket: "YOUR_STORAGE_BUCKET",
		messagingSenderId: "YOUR_SENDER_ID",
		appId: "YOUR_APP_ID"
    };

    // Initialize Firebase
    initializeApp(firebaseConfig);
    
    //write data
    //pid = string, data = object
    function writeData(pid, data){
    	  const db = getDatabase();
		  push(ref(db, '/' + pid), data);
    }
  
    //***jsPsych**
  	const jsPsych = initJsPsych();
  	
  	const trials = [
		{stimulus: "N1-44100.mp3", correct_response:"He looked at the sleeves"},
		{stimulus: "N2-44100.mp3", correct_response:"Bob wore a watch on his wrist"},
		{stimulus: "N3-44100.wav", correct_response:"Mom looked at the juice"},  		  	
	];
  	
  	const preload = {
	    type: jsPsychPreload,
    	audio: ()=>trials.map((item)=>"audio/" + item.stimulus),
    	show_progress_bar: true,
    	show_detailed_errors: true
	}
  	
  	 const welcome_trial = {
  		type: jsPsychHtmlKeyboardResponse,
  		stimulus: "Welcome. Press the any key to get started",
  		post_trial_gap: 500
  	}
  	 const instructions_trial = {
  		type: jsPsychHtmlKeyboardResponse,
  		stimulus: `
	  		<p>Listen to the audio, then type what you heard</p>
  			<p>Press any key to continue</p>  		
  		`,
  		choices: [' '],
  		post_trial_gap: 500
  	}
  	
  	const fixation_trial = {
  		type: jsPsychHtmlKeyboardResponse,
  		stimulus: `
  			<h1>+</h1>
  		`,
  		choices: "NO_KEYS",
  		trial_duration: 500  	
  	}
  	
  	const end_experiment = {
  		type: jsPsychHtmlKeyboardResponse,
  		stimulus: `
  			<h2>Experiment Complete</h2>
  		`,
  		choices: "NO_KEYS",	
  	}
  	
  	const transcriber_timeline = {
  		timeline: [
  			//audio
			{
				type: jsPsychAudioKeyboardResponse,
				stimulus: () => 'audio/' + jsPsych.evaluateTimelineVariable('stimulus'),
				choice: "NO_KEYS",
				prompt: "Please listen",
				trial_ends_after_audio: true
			},

			//textinput			
			{
				type: jsPsychSurveyText,
				questions: [
					{
					prompt: "Type what you heard",
					name: 'transcription',
					rows: 1,
					columns: 40,
					required: true
					}
				],
				button_label: "NEXT",	
				on_finish: (data) => {
					console.log(data);
					//assume participant ID is "p1"
					writeData("p1", data)
				
				}
			},
			
			//fixation cross
			{
				type: jsPsychHtmlKeyboardResponse,
				stimulus: `
					<h1>+</h1>
				`,
				choices: "NO_KEYS",
				trial_duration: 500  	
			}
  		],
  		timeline_variables: trials,
  		randomize_order: true, //randomizes order of timeline variables
  		repetitions: 1
  	}
  	

  	let master_timeline = [];
  	master_timeline.push(preload);
  	master_timeline.push(welcome_trial);
  	master_timeline.push(instructions_trial);
  	master_timeline.push(transcriber_timeline);
  	master_timeline.push(end_experiment);
  	
  	jsPsych.run(master_timeline);
  </script>
  

</html>
